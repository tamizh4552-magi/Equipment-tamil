<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Safety Equipment Request</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background: linear-gradient(135deg,#2b5876,#4e4376);
  min-height:100vh;
  padding:30px;
}
.glass-card{
  background:rgba(255,255,255,.15);
  backdrop-filter: blur(15px);
  border-radius:16px;
  padding:25px;
}
label,h4,h6{color:#fff}
.table thead{background:#4e4376;color:#fff}
.stock-low{color:#ff4d4d;font-weight:600}
.stock-ok{color:#28a745;font-weight:600}
</style>
</head>

<body>
<div class="container">
<div class="glass-card">

<h4>Safety Equipment Request</h4>
<a href="login.html" class="btn btn-info btn-sm mb-3">Login</a>

<form id="gsForm" class="row g-3">

<div class="col-md-6">
<label>Name</label>
<input name="name" class="form-control" required>
</div>

<div class="col-md-6">
<label>User ID</label>
<input name="userid" class="form-control" required>
</div>

<div class="col-md-6">
<label>Supervisor Name</label>
<select name="team_lead" id="teamLead" class="form-control" required></select>
</div>

<div class="col-md-6">
<label>Phone</label>
<input name="phone" class="form-control">
</div>

<div class="col-md-6">
<label>Date</label>
<input type="date" name="date" class="form-control">
</div>

<div class="col-md-6">
<label>Approved To Name</label>
<input name="approved_to" class="form-control">
</div>

<div class="col-12 mt-3">
<h6>Requested Products</h6>

<table class="table table-bordered table-light" id="productTable">
<thead>
<tr>
<th>Product</th>
<th>Size</th>
<th width="80">Qty</th>
<th width="80">Stock</th>
<th width="40"></th>
</tr>
</thead>
<tbody></tbody>
</table>

<button type="button" id="addBtn" class="btn btn-warning btn-sm">➕ Add Product</button>
</div>

<div class="col-12">
<button class="btn btn-success w-100 mt-3">✅ Submit</button>
</div>

</form>
</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwWHPMM4Ya_m6cM0fgKRLWDxvl2sAg1-FrHuO63fWtUw-p4JKJaQdAEWa2A7PT4Z8_4/exec";

const gsForm = document.getElementById("gsForm");
const productTable = document.querySelector("#productTable tbody");
const teamLead = document.getElementById("teamLead");

let products = [];

document.querySelector('[name="date"]').value =
  new Date().toISOString().split("T")[0];

/* ===== LOAD LEADS ===== */
fetch(SCRIPT_URL + "?action=leads")
.then(r=>r.json())
.then(d=>{
  teamLead.innerHTML =
    `<option value="">Select Lead</option>` +
    d.map(x=>`<option>${x.name}</option>`).join("");
});

/* ===== LOAD PRODUCTS ===== */
fetch(SCRIPT_URL + "?action=products")
.then(r=>r.json())
.then(d=>{
  products = d;
  addRow();
});

/* ===== ADD ROW ===== */
function addRow(){
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>
      <select class="p form-control">
        <option value="">Select</option>
      </select>
    </td>

    <td>
      <select class="s form-control" disabled>
        <option value="">Select</option>
      </select>
    </td>

    <td>
      <input type="number" min="1" class="q form-control" disabled>
    </td>

    <td class="st">-</td>

    <td>
      <button type="button" class="btn btn-danger btn-sm">✖</button>
    </td>
  `;

  productTable.appendChild(tr);

  const pSel = tr.querySelector(".p");
  const sSel = tr.querySelector(".s");
  const qty  = tr.querySelector(".q");
  const st   = tr.querySelector(".st");

  /* ================= PRODUCTS ================= */
  [...new Set(products.map(p => p.product))].forEach(p => {
    pSel.innerHTML += `<option value="${p}">${p}</option>`;
  });

  /* ================= PRODUCT CHANGE ================= */
  pSel.addEventListener("change", () => {
    sSel.innerHTML = `<option value="">Select</option>`;
    sSel.disabled = true;
    qty.disabled = true;
    qty.value = "";
    st.textContent = "-";

    if (!pSel.value) return;

    products
      .filter(x => x.product === pSel.value)
      .forEach(x => {
        sSel.innerHTML += `
          <option value="${x.size}" data-stock="${x.stock}">
            ${x.size} (Stock: ${x.stock})
          </option>`;
      });

    sSel.disabled = false;
  });

  /* ================= SIZE CHANGE ================= */
  sSel.addEventListener("change", () => {
    const opt = sSel.selectedOptions[0];
    if (!opt) return;

    const stock = Number(opt.dataset.stock || 0);

    st.textContent = stock;
    st.className = stock < 5 ? "stock-low" : "stock-ok";

    qty.disabled = stock === 0;
    qty.max = stock;
    qty.value = stock > 0 ? 1 : "";
  });

  tr.querySelector("button").onclick = () => tr.remove();
}

document.getElementById("addBtn").onclick = addRow;

/* ===== SUBMIT ===== */
gsForm.onsubmit = e=>{
  e.preventDefault();

  const items=[];
  let error=false;

  document.querySelectorAll("#productTable tr").forEach(r=>{
    const p=r.querySelector(".p")?.value;
    const s=r.querySelector(".s")?.value;
    const q=Number(r.querySelector(".q")?.value);
    const stock=Number(r.querySelector(".s")?.selectedOptions[0]?.dataset.stock||0);

    if(p && s && q){
      if(q>stock){
        alert(`Qty exceeds stock for ${p} (${s})`);
        error=true;
      }
      items.push({product:p,size:s,qty:q});
    }
  });

  if(error || !items.length) return;

  const fd=new FormData(gsForm);
  fd.append("items",JSON.stringify(items));

  fetch(SCRIPT_URL,{method:"POST",body:fd})
    .then(r=>r.json())
    .then(res=>{
      alert(res.message||"Submitted");
      if(res.status==="success") location.reload();
    });
};
</script>
</body>
</html>


