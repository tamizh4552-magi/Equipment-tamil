<!DOCTYPE html>
<html>
<head>
<title>Request Form</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-dark p-4">
<div class="container bg-white p-4 rounded">

<h4>Safety Equipment Request</h4>
<a href="view.html" class="btn btn-info btn-sm mb-3">View Requests</a>

<form id="gs-form">
<input name="name" class="form-control mb-2" placeholder="Name" required>
<input name="userid" class="form-control mb-2" placeholder="User ID" required>

<select name="team_lead" id="teamLead" class="form-control mb-2"></select>
<input name="phone" class="form-control mb-2" placeholder="Phone">
<input type="date" name="date" class="form-control mb-2">
<input name="approved_to" class="form-control mb-2" placeholder="Approved To">

<table class="table" id="productTable">
<thead><tr><th>Product</th><th>Size</th><th>Qty</th><th>Stock</th><th></th></tr></thead>
<tbody></tbody>
</table>

<button type="button" onclick="addRow()" class="btn btn-warning">+ Add</button>
<button class="btn btn-success w-100 mt-3">Submit</button>
</form>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxchKT7ppigyYLhVkX4gFy3y85phZAEOHfh-kKIANXe9y38s8yyCBLS2XHzHEGBjjLNWA/exec";
let products = [];

document.querySelector('[name="date"]').value =
  new Date().toISOString().split("T")[0];

fetch(SCRIPT_URL + "?action=leads")
.then(r=>r.json())
.then(d=>{
  teamLead.innerHTML = `<option value="">Select Lead</option>` +
    d.map(l=>`<option>${l.name}</option>`).join("");
});

fetch(SCRIPT_URL + "?action=products")
.then(r=>r.json())
.then(d=>products=d);

function addRow(){
  const tr = document.createElement("tr");
  tr.innerHTML = `
  <td><select class="p form-control"></select></td>
  <td><select class="s form-control"></select></td>
  <td><input class="q form-control" type="number" min="1"></td>
  <td class="st">-</td>
  <td><button type="button" class="btn btn-danger btn-sm">X</button></td>`;
  productTable.querySelector("tbody").appendChild(tr);

  tr.querySelector(".p").innerHTML =
    `<option></option>` +
    [...new Set(products.map(p=>p.product))].map(p=>`<option>${p}</option>`);

  tr.querySelector(".p").onchange = e=>{
    tr.querySelector(".s").innerHTML =
      products.filter(x=>x.product===e.target.value)
      .map(x=>`<option data-stock="${x.stock}">${x.size}</option>`);
  };

  tr.querySelector(".s").onchange = e=>{
    tr.querySelector(".st").innerText =
      e.target.selectedOptions[0].dataset.stock;
  };

  tr.querySelector("button").onclick = ()=>tr.remove();
}
addRow();

gs-form.onsubmit = e=>{
  e.preventDefault();
  let items=[];
  document.querySelectorAll("#productTable tbody tr").forEach(r=>{
    items.push({
      product:r.querySelector(".p").value,
      size:r.querySelector(".s").value,
      qty:+r.querySelector(".q").value
    });
  });
  const fd = new FormData(gs-form);
  fd.append("items",JSON.stringify(items));
  fetch(SCRIPT_URL,{method:"POST",body:fd})
  .then(r=>r.json())
  .then(()=>alert("Submitted"));
};
</script>
</body>
</html>
