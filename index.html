<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Request Form</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background: linear-gradient(135deg,#2b5876,#4e4376);
    min-height:100vh;
    padding:30px;
}
.glass-card{
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(15px);
    border-radius:15px;
    padding:25px;
}
.form-control{border-radius:10px;}
.table thead{background:#4e4376;color:#fff;}
.stock-info{font-size:0.85rem;color:#555;}
</style>
</head>

<body>
<div class="container">
<div class="glass-card">

<h3 class="text-white text-center mb-3">Request Form</h3>
<div class="text-end mb-3"> <a href="view.html" class="btn btn-info"> ðŸ“„ View Submissions </a> </div>

<form id="gs-form" class="row g-3">

<div class="col-md-6">
<label class="text-light">Name</label>
<input type="text" name="name" class="form-control" required>
</div>

<div class="col-md-6">
<label class="text-light">User ID</label>
<input type="text" name="userid" class="form-control" required>
</div>

<div class="col-md-6">
<label class="text-light">Team Lead Name</label>
<select name="team_lead" id="teamLead" class="form-control" required>
  <option value="">Loading...</option>
</select>
</div>

<div class="col-md-6">
<label class="text-light">Phone</label>
<input type="tel" name="phone" class="form-control"
       pattern="[0-9]{10}" placeholder="10 digit mobile">
</div>

<div class="col-md-6">
<label class="text-light">Date</label>
<input type="date" name="date" class="form-control">
</div>

<div class="col-md-6">
<label class="text-light">Approved To</label>
<input type="text" name="approved_to" class="form-control">
</div>

<hr class="text-white">

<h5 class="text-white">Products</h5>

<table class="table table-bordered table-light" id="productTable">
<thead>
<tr>
<th>Product</th>
<th>Size</th>
<th>Qty</th>
<th>Stock</th>
<th width="60"></th>
</tr>
</thead>
<tbody></tbody>
</table>

<button type="button" class="btn btn-warning" onclick="addRow()">+ Add Product</button>

<div class="col-12 mt-4">
<button class="btn btn-success w-100 py-2 fs-5">Submit</button>
</div>

</form>
</div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3">
<div id="toastSuccess" class="toast bg-success text-white">
<div class="toast-header bg-success text-white">
<strong class="me-auto">Success</strong>
<button class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
</div>
<div class="toast-body">Form submitted successfully</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwESOjz1-8W5bh_ArTu3e8EDup0A4lJB9orzihqn4IINqJzWgwy0MYmPE-QuNFToQciGw/exec";

let productsStock = []; // will hold products + size + stock

/* -------- SET TODAY DATE -------- */
document.querySelector('input[name="date"]').value =
  new Date().toISOString().split("T")[0];

/* -------- LOAD TEAM LEADS -------- */
fetch(SCRIPT_URL + "?action=leads")
.then(r => r.json())
.then(data => {
  const sel = document.getElementById("teamLead");
  sel.innerHTML = `<option value="">Select Team Lead</option>`;
  data.forEach(l => {
    sel.innerHTML += `<option value="${l.name}">${l.name}</option>`;
  });
});

/* -------- LOAD PRODUCTS STOCK -------- */
fetch(SCRIPT_URL + "?action=products") // you need to create a doGet handler returning products stock
.then(r => r.json())
.then(data => { productsStock = data; });

/* -------- PRODUCT ROW -------- */
function addRow(){
  const tbody = document.querySelector("#productTable tbody");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>
      <select class="form-control product" required>
        <option value="">Select Product</option>
        ${productsStock.map(p=>`<option value="${p.product}">${p.product}</option>`).join("")}
      </select>
    </td>
    <td>
      <select class="form-control size" required>
        <option value="">Select Size</option>
      </select>
    </td>
    <td><input type="number" class="form-control qty" min="1" required></td>
    <td><span class="stock-info">-</span></td>
    <td>
      <button type="button" class="btn btn-danger btn-sm">X</button>
    </td>`;

  tbody.appendChild(tr);

  // Remove row
  tr.querySelector("button").addEventListener("click",()=>tr.remove());

  // Update Size options on product change
  const productSelect = tr.querySelector(".product");
  const sizeSelect = tr.querySelector(".size");
  const stockSpan = tr.querySelector(".stock-info");

  productSelect.addEventListener("change",()=>{
    const selectedProduct = productSelect.value;
    const sizes = productsStock.filter(p=>p.product===selectedProduct);
    sizeSelect.innerHTML = `<option value="">Select Size</option>` + sizes.map(s=>
      `<option value="${s.size}" data-stock="${s.stock}">${s.size}</option>`).join("");
    stockSpan.textContent = "-";
  });

  // Update stock display on size change
  sizeSelect.addEventListener("change",()=>{
    const opt = sizeSelect.selectedOptions[0];
    if(opt) stockSpan.textContent = opt.dataset.stock;
    else stockSpan.textContent = "-";
  });
}
addRow();

/* -------- FORM SUBMIT -------- */
document.getElementById("gs-form").addEventListener("submit",function(e){
  e.preventDefault();

  let items=[];
  let valid=true;

  document.querySelectorAll("#productTable tbody tr").forEach(r=>{
    const product = r.querySelector(".product").value;
    const size = r.querySelector(".size").value;
    const qty = parseInt(r.querySelector(".qty").value,10);
    const stock = parseInt(r.querySelector(".size").selectedOptions[0]?.dataset.stock || 0,10);

    if(qty > stock){
      alert(`Quantity for ${product} (${size}) exceeds stock (${stock})`);
      valid=false;
      return;
    }

    items.push({product,size,qty});
  });

  if(!valid || items.length===0){
    return;
  }

  let fd=new FormData(this);
  fd.append("items",JSON.stringify(items));

  fetch(SCRIPT_URL,{method:"POST",body:fd})
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="success"){
      this.reset();
      document.querySelector("#productTable tbody").innerHTML="";
      addRow();
      new bootstrap.Toast(
        document.getElementById("toastSuccess")
      ).show();
    } else {
      alert(res.message);
    }
  })
  .catch(err=>alert(err));
});
</script>

</body>
</html>
