<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Safety Equipment Request</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ===== GLOBAL ===== */
body{
  background:#f4f6f9;
  font-family: "Segoe UI", system-ui, sans-serif;
}

.page-header{
  background:#1f2937;
  color:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}

.page-header h3{margin:0;font-weight:700;}
.page-header small{opacity:.8;}

/* ===== CARD ===== */
.card{
  border:none;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}

.card-header{
  background:#111827;
  color:#fff;
  font-weight:600;
  border-radius:14px 14px 0 0;
}

.card-body{padding:20px;}

/* ===== FORM ===== */
label{
  font-weight:600;
  font-size:.9rem;
  color:#374151;
}

label::after{
  content:" *";
  color:#dc2626;
}

.form-control, select{
  border-radius:10px;
  border:1px solid #d1d5db;
}

.form-control:focus{
  border-color:#2563eb;
  box-shadow:0 0 0 2px rgba(37,99,235,.2);
}

/* ===== TABLE ===== */
.table{
  border-radius:12px;
  overflow:hidden;
}

.table thead{
  background:#2563eb;
  color:#fff;
  font-size:.85rem;
  text-transform:uppercase;
}

.table td{vertical-align:middle;}

.stock-ok{color:#059669;font-weight:700;}
.stock-low{color:#dc2626;font-weight:700;}

/* ===== MODERN ADD BUTTON (NEW) ===== */
.btn-add-modern{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 18px;
  background:linear-gradient(135deg,#f59e0b,#fbbf24);
  color:#111827;
  font-weight:700;
  border:none;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(245,158,11,.35);
  transition:.25s ease;
}

.btn-add-modern:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 30px rgba(245,158,11,.55);
}

.btn-add-modern:active{
  transform:scale(.96);
}

.add-icon{
  font-size:1.2rem;
  line-height:1;
}

/* ===== OTHER BUTTONS ===== */
.btn-delete{background:#ef4444;border:none;}
.btn-delete:hover{background:#dc2626;}

.btn-submit{
  background:#16a34a;
  font-weight:700;
  border-radius:12px;
}

.btn-submit:hover{background:#15803d;}

/* ===== FOOTER NOTE ===== */
.note{
  font-size:.85rem;
  color:#6b7280;
  margin-top:10px;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  .page-header{text-align:center}
  .btn-add-modern{width:100%;justify-content:center;}
}/* ===== PRODUCT VIEW BUTTON ===== */
.btn-view-product{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  background:#2563eb;
  color:#fff;
  font-weight:700;
  border-radius:14px;
  text-decoration:none;
  box-shadow:0 8px 20px rgba(37,99,235,.4);
  transition:.25s ease;
}

.btn-view-product:hover{
  background:#1d4ed8;
  transform:translateY(-2px);
  color:#fff;
}

</style>
</head>

<body>
<div class="container my-4">

<div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2">
  <div>
    <h3>Safety Equipment Request</h3>
    <small>Factory / Site PPE Request Form</small>
  </div>

  <!-- PRODUCT VIEW BUTTON -->
  <a href="view.html" class="btn-view-product">
    ðŸ“¦ Product View
  </a>
</div>


<div class="card">
<div class="card-header">Employee Information</div>
<div class="card-body">

<form id="gsForm" class="row g-3">

<div class="col-md-6">
<label>Name</label>
<input name="name" class="form-control" required>
</div>

<div class="col-md-6">
<label>User ID</label>
<input name="userid" class="form-control" required>
</div>

<div class="col-md-6">
<label>Supervisor</label>
<select name="team_lead" id="teamLead" class="form-control" required></select>
</div>

<div class="col-md-6">
<label>Phone</label>
<input name="phone" class="form-control">
</div>

<div class="col-md-6">
<label>Date</label>
<input type="date" name="date" class="form-control">
</div>

<div class="col-md-6">
<label>Approved To</label>
<input name="approved_to" class="form-control">
</div>

<hr class="my-4">

<h6 class="fw-bold text-secondary">Requested Equipment</h6>

<table class="table table-bordered" id="productTable">
<thead>
<tr>
<th>Product</th>
<th>Size</th>
<th width="90">Qty</th>
<th width="90">Stock</th>
<th width="50"></th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- âœ… NEW ADD BUTTON (ID SAME) -->
<button type="button" id="addBtn" class="btn-add-modern">
  <span class="add-icon">ï¼‹</span>
  Add Equipment
</button>

<div class="col-12 mt-4">
<button class="btn btn-submit w-100">Submit Request</button>
</div>

<p class="note">âš  Ensure requested quantity does not exceed available stock.</p>

</form>
</div>
</div>

</div>

<!-- âœ… JS UNCHANGED -->
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNaMqWmL1R4pPdRv2EMJahYI4hW503jBkhqPXsjsRxPS9925MXlCrJTnvnEoV_DBoI/exec";

const gsForm = document.getElementById("gsForm");
const productTable = document.querySelector("#productTable tbody");
const teamLead = document.getElementById("teamLead");

let products = [];

document.querySelector('[name="date"]').value =
  new Date().toISOString().split("T")[0];

/* ===== LOAD LEADS ===== */
fetch(SCRIPT_URL + "?action=leads")
.then(r=>r.json())
.then(d=>{
  teamLead.innerHTML =
    `<option value="">Select Lead</option>` +
    d.map(x=>`<option>${x.name}</option>`).join("");
});

/* ===== LOAD PRODUCTS ===== */
fetch(SCRIPT_URL + "?action=products")
.then(r=>r.json())
.then(d=>{
  products = d;
  addRow();
});

/* ===== ADD ROW ===== */
function addRow(){
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>
      <select class="p form-control">
        <option value="">Select</option>
      </select>
    </td>

    <td>
      <select class="s form-control" disabled>
        <option value="">Select</option>
      </select>
    </td>

    <td>
      <input type="number" min="1" class="q form-control" disabled>
    </td>

    <td class="st">-</td>

    <td>
      <button type="button" class="btn btn-danger btn-sm">âœ–</button>
    </td>
  `;

  productTable.appendChild(tr);

  const pSel = tr.querySelector(".p");
  const sSel = tr.querySelector(".s");
  const qty  = tr.querySelector(".q");
  const st   = tr.querySelector(".st");

  /* ================= PRODUCTS ================= */
  [...new Set(products.map(p => p.product))].forEach(p => {
    pSel.innerHTML += `<option value="${p}">${p}</option>`;
  });

  /* ================= PRODUCT CHANGE ================= */
  pSel.addEventListener("change", () => {
    sSel.innerHTML = `<option value="">Select</option>`;
    sSel.disabled = true;
    qty.disabled = true;
    qty.value = "";
    st.textContent = "-";

    if (!pSel.value) return;

    products
      .filter(x => x.product === pSel.value)
      .forEach(x => {
        sSel.innerHTML += `
          <option value="${x.size}" data-stock="${x.stock}">
            ${x.size} (Stock: ${x.stock})
          </option>`;
      });

    sSel.disabled = false;
  });

  /* ================= SIZE CHANGE ================= */
  sSel.addEventListener("change", () => {
    const opt = sSel.selectedOptions[0];
    if (!opt) return;

    const stock = Number(opt.dataset.stock || 0);

    st.textContent = stock;
    st.className = stock < 5 ? "stock-low" : "stock-ok";

    qty.disabled = stock === 0;
    qty.max = stock;
    qty.value = stock > 0 ? 1 : "";
  });

  tr.querySelector("button").onclick = () => tr.remove();
}

document.getElementById("addBtn").onclick = addRow;

/* ===== SUBMIT ===== */
gsForm.onsubmit = e=>{
  e.preventDefault();

  const items=[];
  let error=false;

  document.querySelectorAll("#productTable tr").forEach(r=>{
    const p=r.querySelector(".p")?.value;
    const s=r.querySelector(".s")?.value;
    const q=Number(r.querySelector(".q")?.value);
    const stock=Number(r.querySelector(".s")?.selectedOptions[0]?.dataset.stock||0);

    if(p && s && q){
      if(q>stock){
        alert(`Qty exceeds stock for ${p} (${s})`);
        error=true;
      }
      items.push({product:p,size:s,qty:q});
    }
  });

  if(error || !items.length) return;

  const fd=new FormData(gsForm);
  fd.append("items",JSON.stringify(items));

  fetch(SCRIPT_URL,{method:"POST",body:fd})
    .then(r=>r.json())
    .then(res=>{
      alert(res.message||"Submitted");
      if(res.status==="success") location.reload();
    });
};
</script>

</body>
</html>
