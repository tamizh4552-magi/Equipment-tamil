<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submitted Requests</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    background: #f0f2f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
}
h3 {
    color: #343a40;
    margin-bottom: 15px;
}
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.table th {
    background-color: #e9ecef;
}
.search-box {
    max-width: 300px;
}
</style>
</head>

<body>

<div class="container">

    <h3>üìù Submitted Safety Equipment Requests</h3>

    <div class="top-bar">
        <a href="index.html" class="btn btn-secondary">‚¨Ö Back</a>

        <input type="text" id="searchInput" class="form-control search-box"
               placeholder="üîç Search..." onkeyup="filterTable()">

        <div>
            <button class="btn btn-success me-2" onclick="exportToCSV()">‚¨á Export Excel</button>
            <button class="btn btn-danger" onclick="exportToPDF()">‚¨á Download PDF</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="dataTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>User ID</th>
                    <th>Date</th>
                    <th>Phone</th>
                    <th>Team Lead</th>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Qty</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

</div>

<!-- PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
const API = "https://script.google.com/macros/s/AKfycbwWHPMM4Ya_m6cM0fgKRLWDxvl2sAg1-FrHuO63fWtUw-p4JKJaQdAEWa2A7PT4Z8_4/exec?action=view";

async function loadRequests() {
    const res = await fetch(API);
    const data = await res.json();
    const tbody = document.getElementById("table-body");

    if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">No data</td></tr>`;
        return;
    }

    tbody.innerHTML = data.map(r =>
        r.items.map(i => `
            <tr>
                <td>${r.name}</td>
                <td>${r.userid}</td>
                <td>${new Date(r.timestamp).toISOString().split('T')[0]}</td>
                <td>${r.phone}</td>
                <td>${r.team_lead}</td>
                <td>${i.product}</td>
                <td>${i.size}</td>
                <td>${i.qty}</td>
            </tr>
        `).join("")
    ).join("");
}

loadRequests();


// üîç SEARCH FILTER
function filterTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#dataTable tbody tr");

    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
    });
}


// üì§ EXPORT FILTERED DATA TO CSV
function exportToCSV() {
    let csv = [];
    const rows = document.querySelectorAll("#dataTable tr");

    rows.forEach(row => {
        if (row.style.display === "none") return;

        const cols = row.querySelectorAll("th, td");
        let rowData = [];
        cols.forEach(col => rowData.push(`"${col.innerText.replace(/"/g, '""')}"`));
        csv.push(rowData.join(","));
    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "Filtered_Safety_Requests.csv";
    a.click();
    URL.revokeObjectURL(url);
}


// üìÑ EXPORT FILTERED DATA TO PDF
function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("l", "mm", "a4");

    doc.text("Filtered Safety Equipment Requests", 14, 15);

    let body = [];
    const rows = document.querySelectorAll("#dataTable tbody tr");

    rows.forEach(row => {
        if (row.style.display === "none") return;
        body.push([...row.children].map(td => td.innerText));
    });

    doc.autoTable({
        head: [[
            "Name","User ID","Date","Phone",
            "Team Lead","Product","Size","Qty"
        ]],
        body: body,
        startY: 20,
        styles: { fontSize: 8 },
        theme: "grid"
    });

    doc.save("Filtered_Safety_Requests.pdf");
}
</script>

</body>
</html>
