<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submitted Requests</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#f4f6f9;
    font-family:"Segoe UI",system-ui,sans-serif;
    padding:20px;
}

/* ===== PAGE HEADER ===== */
.page-header{
    background:#1f2937;
    color:#fff;
    padding:18px 22px;
    border-radius:14px;
    margin-bottom:20px;
}

.page-header h4{
    margin:0;
    font-weight:700;
}

.page-header small{
    opacity:.85;
}

/* ===== ACTION BAR ===== */
.action-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    background:#ffffff;
    padding:14px;
    border-radius:14px;
    box-shadow:0 8px 20px rgba(0,0,0,.06);
    margin-bottom:15px;
    flex-wrap:wrap;
}

/* ===== SEARCH ===== */
.search-box{
    max-width:280px;
}

/* ===== BUTTONS ===== */
.btn-back{
    background:#6b7280;
    color:#fff;
    font-weight:600;
    border-radius:10px;
}

.btn-stock{
    background:#2563eb;
    color:#fff;
    font-weight:700;
    border-radius:10px;
}

.btn-excel{
    background:#16a34a;
    color:#fff;
    font-weight:700;
    border-radius:10px;
}

.btn-pdf{
    background:#dc2626;
    color:#fff;
    font-weight:700;
    border-radius:10px;
}

/* ===== TABLE CARD ===== */
.card{
    border:none;
    border-radius:16px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
}

.table thead{
    background:#2563eb;
    color:#fff;
    font-size:.85rem;
    text-transform:uppercase;
}

.table td{
    vertical-align:middle;
    font-size:.9rem;
}

/* ===== MOBILE ===== */
@media(max-width:768px){
    .action-bar{
        flex-direction:column;
        align-items:stretch;
    }
    .search-box{
        max-width:100%;
    }
}
</style>
</head>

<body>

<div class="container">

<!-- HEADER -->
<div class="page-header">
    <h4>üìù Submitted Safety Equipment Requests</h4>
    <small>View, search & export submitted PPE requests</small>
</div>

<!-- ACTION BAR -->
<div class="action-bar">

    <a href="index.html" class="btn btn-back">
        ‚¨Ö Back
    </a>

    <input type="text" id="searchInput"
           class="form-control search-box"
           placeholder="üîç Search..."
           onkeyup="filterTable()">

    <div class="d-flex gap-2 flex-wrap">
        <a href="product-stock.html" class="btn btn-stock">
            üì¶ Product Stock
        </a>

        <button class="btn btn-excel" onclick="exportToCSV()">
            ‚¨á Export Excel
        </button>

        <button class="btn btn-pdf" onclick="exportToPDF()">
            ‚¨á Download PDF
        </button>
    </div>
</div>

<!-- TABLE -->
<div class="card">
<div class="table-responsive">
<table class="table table-bordered table-striped mb-0" id="dataTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>User ID</th>
            <th>Date</th>
            <th>Phone</th>
            <th>Supervisor</th>
            <th>Product</th>
            <th>Size</th>
            <th>Qty</th>
        </tr>
    </thead>
    <tbody id="table-body"></tbody>
</table>
</div>
</div>

</div>

<!-- PDF LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
const API = "https://script.google.com/macros/s/AKfycbyNaMqWmL1R4pPdRv2EMJahYI4hW503jBkhqPXsjsRxPS9925MXlCrJTnvnEoV_DBoI/exec?action=view";

async function loadRequests(){
    const res = await fetch(API);
    const data = await res.json();
    const tbody = document.getElementById("table-body");

    if(!data || data.length===0){
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4">No records found</td></tr>`;
        return;
    }

    tbody.innerHTML = data.map(r =>
        r.items.map(i => `
            <tr>
                <td>${r.name}</td>
                <td>${r.userid}</td>
                <td>${new Date(r.timestamp).toISOString().split('T')[0]}</td>
                <td>${r.phone}</td>
                <td>${r.team_lead}</td>
                <td>${i.product}</td>
                <td>${i.size}</td>
                <td>${i.qty}</td>
            </tr>
        `).join("")
    ).join("");
}
loadRequests();

/* SEARCH */
function filterTable(){
    const v=document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataTable tbody tr")
      .forEach(r=>r.style.display=r.innerText.toLowerCase().includes(v)?"":"none");
}

/* EXPORT CSV */
function exportToCSV(){
    let csv=[];
    document.querySelectorAll("#dataTable tr").forEach(r=>{
        if(r.style.display==="none") return;
        csv.push([...r.children].map(c=>`"${c.innerText}"`).join(","));
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv.join("\n")],{type:"text/csv"}));
    a.download="Safety_Requests.csv";
    a.click();
}

/* EXPORT PDF */
function exportToPDF(){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF("l","mm","a4");
    doc.text("Safety Equipment Requests",14,15);

    let body=[];
    document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
        if(r.style.display==="none") return;
        body.push([...r.children].map(td=>td.innerText));
    });

    doc.autoTable({
        head:[["Name","User ID","Date","Phone","Supervisor","Product","Size","Qty"]],
        body:body,
        startY:20,
        styles:{fontSize:8},
        theme:"grid"
    });

    doc.save("Safety_Requests.pdf");
}
</script>

</body>
</html>
