<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product Stock</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  background:#f4f6f8;
  padding:20px;
  font-family:Segoe UI,Tahoma;
}
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
}
.search-box{max-width:300px;}
.low-stock{background:#fff3cd !important;}
.no-stock{background:#f8d7da !important;}
</style>
</head>

<body>

<div class="container">

<h3>ðŸ“¦ Product Stock (Live)</h3>

<div class="top-bar mb-3">
  <a href="index.html" class="btn btn-secondary">â¬… Back</a>

  <input type="text" id="search" class="form-control search-box"
         placeholder="ðŸ” Search product / size" onkeyup="filterTable()">

  <div>
    <button class="btn btn-success me-2" onclick="exportCSV()">â¬‡ Export Excel</button>
    <button class="btn btn-danger" onclick="exportPDF()">â¬‡ Download PDF</button>
  </div>
</div>

<div class="table-responsive">
<table class="table table-bordered table-striped" id="stockTable">
<thead>
<tr>
  <th>Product</th>
  <th>Size</th>
  <th>Stock</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
const API =
"https://script.google.com/macros/s/AKfycbwWHPMM4Ya_m6cM0fgKRLWDxvl2sAg1-FrHuO63fWtUw-p4JKJaQdAEWa2A7PT4Z8_4/exec?action=products";

async function loadStock(){
  const res = await fetch(API);
  const data = await res.json();
  const tbody = document.getElementById("tbody");

  tbody.innerHTML = data.map(p=>{
    let cls = "";
    if(p.stock == 0) cls="no-stock";
    else if(p.stock <= 5) cls="low-stock";

    return `
      <tr class="${cls}">
        <td>${p.product}</td>
        <td>${p.size}</td>
        <td>${p.stock}</td>
      </tr>
    `;
  }).join("");
}
loadStock();

/* SEARCH */
function filterTable(){
  const v = search.value.toLowerCase();
  document.querySelectorAll("#stockTable tbody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(v) ? "" : "none";
  });
}

/* CSV EXPORT (FILTERED) */
function exportCSV(){
  let csv=[];
  document.querySelectorAll("#stockTable tr").forEach(r=>{
    if(r.style.display==="none") return;
    let cols=[...r.children].map(c=>`"${c.innerText}"`);
    csv.push(cols.join(","));
  });

  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Product_Stock.csv";
  a.click();
}

/* PDF EXPORT (FILTERED) */
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  let body=[];
  document.querySelectorAll("#stockTable tbody tr").forEach(r=>{
    if(r.style.display==="none") return;
    body.push([...r.children].map(c=>c.innerText));
  });

  doc.text("Product Stock Report",14,15);
  doc.autoTable({
    head:[["Product","Size","Stock"]],
    body:body,
    startY:20,
    styles:{fontSize:9},
    theme:"grid"
  });

  doc.save("Product_Stock.pdf");
}
</script>

</body>
</html>
